<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout :: layout(~{::#content})}">
<body>
<section id="content" th:with="pageTitle='BATCH JOBS', activeMenu='batch-jobs'">


  <div class="pagehead">
   
  </div>

  <section class="panel">
    <div class="panel__head">
      <h2 class="panel__title">Monthly Invoice Batch</h2>
      <div class="panel__meta">
        <span class="chip chip--neutral">Attempts</span>
        <span class="chip chip--neutral">Fails</span>
      </div>
    </div>

    <div class="panel__body">

      <div class="tabs">
        <a class="tab"
           th:classappend="${tab == null or tab == 'attempts'} ? ' is-active' : ''"
           th:href="@{/batch-jobs(tab='attempts', yyyymm=${yyyymm}, limit=${limit})}">
          Attempts
        </a>
        <a class="tab"
           th:classappend="${tab == 'fails'} ? ' is-active' : ''"
           th:href="@{/batch-jobs(tab='fails', yyyymm=${yyyymm}, limit=${limit})}">
          Fails
        </a>
      </div>

      <div class="hint mt-8 mb-14">
        <strong>참고:</strong>
        Fail 탭은 <code>monthly_invoice_batch_fail</code> 단독으로 월 필터가 불가능해서
        <code>attempt JOIN</code>으로 <code>yyyymm</code> 필터링됩니다.
      </div>

      <div class="split split--auto-fixed">

        <div class="panel mt-0">
          <div class="panel__head">
            <h3 class="panel__title">Filters</h3>
            <div class="panel__meta"><span class="hint">yyyymm / limit / (fails: attemptId)</span></div>
          </div>
          <div class="panel__body">
            <form class="filterbar filterbar--flat mt-0 mb-0" th:action="@{/batch-jobs}" method="get">
              <div class="filterbar__row">
                <div class="field">
                  <label class="label">yyyymm</label>
                  <input class="input w-140" name="yyyymm" type="text" placeholder="202601"
                         th:value="${yyyymm}" data-numeric="true"/>
                </div>


                <div class="field" th:if="${tab == 'fails'}">
                  <label class="label">attemptId (opt)</label>
                  <input class="input w-160" name="attemptId" type="text" placeholder="123"
                         th:value="${attemptId}" />
                </div>

                <input type="hidden" name="tab" th:value="${tab}" />

                <div class="field field--actions">
                    <label class="label">&nbsp;</label>
                    <div class="flex-row flex-row--tight">
                        <button class="btn btn--primary" type="submit">Apply</button>
                        <a class="btn btn--ghost" th:href="@{/batch-jobs(tab=${tab})}">Reset</a>
                    </div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="panel mt-0" th:if="${tab == null or tab == 'attempts'}">
          <div class="panel__head">
            <h3 class="panel__title">Status 통계</h3>
            <div class="panel__meta"><span class="hint">Attempt 기준</span></div>
          </div>
          <div class="panel__body">
            <div class="panel__body">
  <div th:if="${stats == null or #lists.isEmpty(stats)}" class="hint">데이터 없음</div>

  <div th:each="s : ${stats}"
       class="statline">
    <span class="chip mono"
          th:text="${s.status}"
          th:classappend="${
            s.status == 'SUCCESS' or s.status == 'DONE' or s.status == 'COMPLETED'
            ? ' chip--success' :
            (s.status == 'FAIL' or s.status == 'FAILED'
            ? ' chip--danger' : ' chip--neutral')
          }">SUCCESS</span>

    <span class="mono statline__value"
          th:text="${s.cnt}">10</span>
  </div>
</div>


          </div>
        </div>
      </div>

      <div th:if="${tab == null or tab == 'attempts'}" class="mt-20">
        <section class="panel mt-0">
          <div class="panel__head">
            <h3 class="panel__title">최근 실행 목록</h3>
            <div class="panel__meta">
              <span class="hint">last fail column includes summary of the most recent failure.</span>
            </div>
          </div>

          <div class="panel__body">
            <div class="table-wrap is-sticky">
              <table class="table">
                <thead>
                <tr>
                  <th class="col-md">attemptId</th>
                  <th class="col-md">status</th>
                  <th class="col-md">type</th>
                  <th class="col-lg">time</th>
                  <th class="col-lg">counts</th>
                  <th class="col-md">host</th>
                  <th class="col-lg">last fail</th>
                  <th class="col-md">actions</th>
                </tr>
                </thead>

                <tbody>
                <tr th:if="${rows == null || #lists.isEmpty(rows)}">
                  <td class="td-muted" colspan="8">데이터 없음</td>
                </tr>

                <tr th:each="r : ${rows}">
                  <td class="mono" th:text="${r.attemptId}">1</td>

                  <td>
                    <span class="chip mono"
                          th:text="${r.executionStatus} ?: '-'"
                          th:classappend="${
                            r.executionStatus == 'SUCCESS' or r.executionStatus == 'DONE' or r.executionStatus == 'COMPLETED'
                            ? ' chip--success' :
                            (r.executionStatus == 'FAIL' or r.executionStatus == 'FAILED'
                            ? ' chip--danger' : ' chip--neutral')
                          }">SUCCESS</span>
                  </td>

                  <td class="mono" th:text="${r.executionType} ?: '-'">MANUAL</td>

                  <td class="mono">
                    <div th:text="${r.startedAt} ?: '-'">-</div>
                    <div class="hint" th:text="${r.endedAt} ?: '-'">-</div>
                  </td>

                  <td class="mono">
                    <div class="kpi__label">T: <span th:text="${r.targetCount}">0</span></div>
                    <div>O: <span th:text="${r.successCount}">0</span> / F: <span class="kpi__value--danger" th:text="${r.failCount}">0</span></div>
                  </td>

                  <td class="mono" th:text="${r.hostName} ?: '-'">host</td>
                  <td class="break-all mono" th:text="${r.lastFailSummary} ?: '-'">-</td>

                  <td>
                    <a class="btn btn--small btn--ghost"
                       th:href="@{/batch-jobs(tab='fails', yyyymm=${yyyymm}, attemptId=${r.attemptId}, limit=${limit})}">
                      fails
                    </a>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <div th:if="${tab == 'fails'}" class="mt-20">
        <section class="panel mt-0">
          <div class="panel__head">
            <h3 class="panel__title">Fail 목록</h3>
            <div class="panel__meta">
              <span class="hint">yyyymm은 attempt JOIN으로 필터링됩니다.</span>
            </div>
          </div>

          <div class="panel__body">
            <div class="table-wrap is-sticky">
              <table class="table">
                <thead>
                <tr>
                  <th class="col-md">failId</th>
                  <th class="col-md">attemptId</th>
                  <th class="col-lg">createdAt</th>
                  <th class="col-md">catId</th>
                  <th class="col-md">billHistId</th>
                  <th class="col-md">code</th>
                  <th class="col-lg">message</th>
                </tr>
                </thead>

                <tbody>
                <tr th:if="${fails == null || #lists.isEmpty(fails)}">
                  <td class="td-muted" colspan="7">데이터 없음</td>
                </tr>

                <tr th:each="f : ${fails}">
                  <td class="mono" th:text="${f.failId}">1</td>
                  <td class="mono" th:text="${f.attemptId}">1</td>
                  <td class="mono" th:text="${f.createdAt} ?: '-'">-</td>
                  <td class="mono" th:text="${f.invoiceCategoryId} ?: '-'">-</td>
                  <td class="mono" th:text="${f.billingHistoryId} ?: '-'">-</td>
                  <td class="mono" th:text="${f.errorCode} ?: '-'">-</td>
                  <td class="break-all mono" th:text="${f.errorMessage} ?: '-'">-</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

    </div>
  </section>
</section>
</body>
</html>