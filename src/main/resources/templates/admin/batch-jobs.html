<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout :: layout(~{::#content})}">
<body>
<section id="content" th:with="pageTitle='BATCH JOBS', activeMenu='batch-jobs'">

  <div class="pagehead"></div>

  <section class="panel">
    <div class="panel__head">
      <h2 class="panel__title">Monthly Invoice Batch</h2>
      <div class="panel__meta">
        <span class="chip chip--neutral">Attempts</span>
        <span class="chip chip--neutral">Fails</span>
      </div>
    </div>

    <div class="panel__body">

      <div class="tabs">
        <a class="tab"
           th:classappend="${tab == null or tab == 'attempts'} ? ' is-active' : ''"
           th:href="@{/batch-jobs(tab='attempts', yyyymm=${yyyymm}, limit=${limit})}">
          Attempts
        </a>
        <a class="tab"
           th:classappend="${tab == 'fails'} ? ' is-active' : ''"
           th:href="@{/batch-jobs(tab='fails', yyyymm=${yyyymm}, limit=${limit})}">
          Fails
        </a>
      </div>

      <!-- 검색은 기존대로 GET 유지 -->
      <form class="filterbar" th:action="@{/batch-jobs}" method="get">
        <div class="filterbar__row">
          <div class="field">
            <label class="label">정산 월 (YYYYMM)</label>
            <input class="input w-140" name="yyyymm" type="text" placeholder="YYYYMM"
                   th:value="${yyyymm}" data-numeric="true"/>
          </div>

          <div class="field" th:if="${tab == 'fails'}">
            <label class="label">Attempt Id</label>
            <input class="input w-160" name="attemptId" type="text" placeholder="ID"
                   th:value="${attemptId}" />
          </div>

          <input type="hidden" name="tab" th:value="${tab}" />

          <!-- ✅ CSRF: 레이아웃 head를 건드리지 않기 위해 hidden input으로 보관 -->
          <input type="hidden" id="csrfHeader" th:value="${_csrf != null ? _csrf.headerName : ''}">
          <input type="hidden" id="csrfToken"  th:value="${_csrf != null ? _csrf.token : ''}">

          <div class="field field--actions">
            <label class="label">&nbsp;</label>
            <div class="flex-row flex-row--tight">
              <button class="btn btn--primary" type="submit">Search</button>

              <!-- ✅ 화면 이동 없이 AJAX로 POST -->
              <button id="btn-settle-retry" class="btn btn--danger" type="button" onclick="settlementRetryAll();">
                정산 실패 전체 재시도
              </button>

              <button id="btn-settle-resume" class="btn btn--ghost" type="button" onclick="settlementResume();">
                중단 배치 재개
              </button>
            </div>
          </div>
        </div>
      </form>

      <!-- Attempts -->
      <div th:if="${tab == null or tab == 'attempts'}" class="mt-20">
        <section class="panel mt-0">
          <div class="panel__head">
            <h3 class="panel__title">최근 실행 목록</h3>
            <div class="panel__meta">
              <span class="hint">last fail column includes summary of the most recent failure.</span>
            </div>
          </div>

          <div class="panel__body">
            <div class="table-wrap is-sticky">
              <table class="table">
                <thead>
                <tr>
                  <th class="col-md">attemptId</th>
                  <th class="col-md">status</th>
                  <th class="col-md">type</th>
                  <th class="col-lg">time</th>
                  <th class="col-lg">counts</th>
                  <th class="col-md">host</th>
                  <th class="col-lg">last fail</th>
                  <th class="col-md">actions</th>
                </tr>
                </thead>

                <tbody>
                <tr th:if="${rows == null || #lists.isEmpty(rows)}">
                  <td class="td-muted" colspan="8">데이터 없음</td>
                </tr>

                <tr th:each="r : ${rows}">
                  <td class="mono" th:text="${r.attemptId}">1</td>

                  <td>
                    <span class="chip mono"
                          th:text="${r.executionStatus} ?: '-'"
                          th:classappend="${
                            r.executionStatus == 'SUCCESS' or r.executionStatus == 'DONE' or r.executionStatus == 'COMPLETED'
                            ? ' chip--success' :
                            (r.executionStatus == 'FAIL' or r.executionStatus == 'FAILED'
                            ? ' chip--danger' : ' chip--neutral')
                          }">SUCCESS</span>
                  </td>

                  <td class="mono" th:text="${r.executionType} ?: '-'">MANUAL</td>

                  <td class="mono">
                    <div th:text="${r.startedAt} ?: '-'">-</div>
                    <div class="hint" th:text="${r.endedAt} ?: '-'">-</div>
                  </td>

                  <td class="mono">
                    <div class="kpi__label">T: <span th:text="${r.targetCount}">0</span></div>
                    <div>O: <span th:text="${r.successCount}">0</span> / F: <span class="kpi__value--danger" th:text="${r.failCount}">0</span></div>
                  </td>

                  <td class="mono" th:text="${r.hostName} ?: '-'">host</td>
                  <td class="break-all mono" th:text="${r.lastFailSummary} ?: '-'">-</td>

                  <td>
                    <a class="btn btn--small btn--ghost"
                       th:href="@{/batch-jobs(tab='fails', yyyymm=${yyyymm}, attemptId=${r.attemptId}, limit=${limit})}">
                      실패내역
                    </a>
                    <!-- 기존 attempt 재시도 버튼은 유지(원하면 이것도 fetch로 바꿔줄 수 있음) -->
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <!-- Fails -->
      <div th:if="${tab == 'fails'}" class="mt-20">
        <section class="panel mt-0">
          <div class="panel__head">
            <h3 class="panel__title">배치 실패 내역</h3>
            <div class="panel__meta">
              <span class="hint">yyyymm은 attempt JOIN으로 필터링됩니다.</span>
            </div>
          </div>

          <div class="panel__body">
            <div class="table-wrap is-sticky">
              <table class="table">
                <thead>
                <tr>
                  <th class="col-md">failId</th>
                  <th class="col-md">attemptId</th>
                  <th class="col-lg">createdAt</th>
                  <th class="col-md">catId</th>
                  <th class="col-md">billHistId</th>
                  <th class="col-md">code</th>
                  <th class="col-lg">message</th>
                  <th class="col-md">actions</th>
                </tr>
                </thead>

                <tbody>
                <tr th:if="${fails == null || #lists.isEmpty(fails)}">
                  <td class="td-muted" colspan="8">데이터 없음</td>
                </tr>

                <tr th:each="f : ${fails}">
                  <td class="mono" th:text="${f.failId}">1</td>
                  <td class="mono" th:text="${f.attemptId}">1</td>
                  <td class="mono" th:text="${f.createdAt} ?: '-'">-</td>
                  <td class="mono" th:text="${f.invoiceCategoryId} ?: '-'">-</td>
                  <td class="mono" th:text="${f.billingHistoryId} ?: '-'">-</td>
                  <td class="mono" th:text="${f.errorCode} ?: '-'">-</td>
                  <td class="break-all mono" th:text="${f.errorMessage} ?: '-'">-</td>
                  <td>
                    <!-- 기존 fail 재시도 버튼은 유지(원하면 이것도 fetch로 바꿔줄 수 있음) -->
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

    </div>
  </section>

  <!-- ✅ 토스트 UI (CSS 최소, 레이아웃 안 건드림) -->
  <style>
    .toast-wrap {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      pointer-events: none;
      background: rgba(20, 20, 20, 0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      max-width: 360px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.2);
      line-height: 1.35;
      white-space: pre-line;
    }
  </style>
  <div class="toast-wrap" id="toastWrap"></div>

  <script th:inline="javascript">
    const URL_SETTLEMENT_RETRY_ALL = /*[[@{/api/batch/settlement/retry}]]*/ '/api/batch/settlement/retry';
    const URL_SETTLEMENT_RESUME    = /*[[@{/api/batch/settlement/resume}]]*/ '/api/batch/settlement/resume';

    function readCsrf() {
      const header = document.getElementById('csrfHeader')?.value || '';
      const token = document.getElementById('csrfToken')?.value || '';
      if (!header || !token) return null;
      return { header, token };
    }

    function yyyymmValue() {
      const el = document.querySelector('input[name="yyyymm"]');
      return el ? (el.value || '').trim() : '';
    }

    function setBusy(btnId, busy) {
      const b = document.getElementById(btnId);
      if (!b) return;
      b.disabled = !!busy;
      b.classList.toggle('is-loading', !!busy);
    }

    function toast(msg) {
      const wrap = document.getElementById('toastWrap');
      if (!wrap) return alert(msg);

      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;

      wrap.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transition = 'opacity 250ms ease';
      }, 2200);
      setTimeout(() => el.remove(), 2600);
    }

    async function postAjax(url) {
      const csrf = readCsrf();
      const headers = { 'Content-Type': 'application/json' };
      if (csrf) headers[csrf.header] = csrf.token;

      // 서버가 파라미터를 받는다면 yyyymm을 query로 붙여 보냄(없어도 문제 없음)
      const ym = yyyymmValue();
      const fullUrl = ym ? (url + '?yyyymm=' + encodeURIComponent(ym)) : url;

      const res = await fetch(fullUrl, {
        method: 'POST',
        headers,
        body: '{}' // JSON 빈 바디
      });

      const text = await res.text().catch(() => '');
      return { ok: res.ok, status: res.status, text };
    }

    async function settlementRetryAll() {
      if (!confirm('정산 실패한 모든 원천 데이터를 재시도 배치로 돌립니다. 진행할까요?')) return;
      setBusy('btn-settle-retry', true);
      try {
        const r = await postAjax(URL_SETTLEMENT_RETRY_ALL);
        if (r.ok) toast('✅ 재시도 요청 완료');
        else toast(`❌ 재시도 요청 실패 (${r.status})\n${r.text}`);
      } catch (e) {
        toast('❌ 네트워크/서버 오류');
      } finally {
        setBusy('btn-settle-retry', false);
      }
    }

    async function settlementResume() {
      if (!confirm('중단된 배치 재개를 실행합니다. 진행할까요?')) return;
      setBusy('btn-settle-resume', true);
      try {
        const r = await postAjax(URL_SETTLEMENT_RESUME);

        // 지금 서버가 "중단 배치 없음"을 500으로 던지는 구조라면, UI에서만 임시로 정상 메시지 처리
        if (r.ok) {
          toast('✅ 재개 요청 완료');
        } else if (r.status === 500 && (r.text || '').includes('중단된 배치를 찾을 수 없습니다')) {
          toast('ℹ️ 중단된 배치가 없습니다 (재개할 작업 없음)');
        } else {
          toast(`❌ 재개 요청 실패 (${r.status})\n${r.text}`);
        }
      } catch (e) {
        toast('❌ 네트워크/서버 오류');
      } finally {
        setBusy('btn-settle-resume', false);
      }
    }
  </script>

</section>
</body>
</html>
