<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::#content})}">

<body>

<section id="content">
  <div class="panel">

    <div class="panel__head">
      <h2 class="panel__title">청구 발송 현황 (Overview)</h2>
      <div class="panel__meta">
        <span class="chip">청구월: <strong th:text="${billing_yyyymm} ?: 'ALL'">ALL</strong></span>
      </div>
    </div>

    <div class="panel__body">

      <!-- KPI: Batch / Sending -->
      <div class="grid grid--6">
        <!-- Batch KPI -->
        <div class="card is-clickable"
             th:onclick="|location.href='@{/batch-jobs(billing_yyyymm=${billing_yyyymm})}'|">
          <div class="card__label">정산 대상 수</div>
          <div class="card__value" th:text="${billingTargetCount} ?: 0">0</div>
        </div>

        <div class="card is-clickable"
             th:onclick="|location.href='@{/batch-jobs(billing_yyyymm=${billing_yyyymm})}'|">
          <div class="card__label">정산 완료 수</div>
          <div class="card__value" th:text="${batchOkCount} ?: 0">0</div>
        </div>

        <div class="card is-clickable"
             th:onclick="|location.href='@{/batch-jobs(billing_yyyymm=${billing_yyyymm})}'|">
          <div class="card__label">정산 실패 수</div>
          <div class="card__value" th:text="${batchFailCount} ?: 0">0</div>
        </div>

        <!-- Sending KPI -->
        <div class="card is-clickable"
             th:onclick="|location.href='@{/sending(billing_yyyymm=${billing_yyyymm})}'|">
          <div class="card__label">발송 대상 수</div>
          <div class="card__value" th:text="${sendingTargetCount} ?: 0">0</div>
        </div>

        <div class="card is-clickable"
             th:onclick="|location.href='@{/sending(billing_yyyymm=${billing_yyyymm}, status='SENT')}'|">
          <div class="card__label">발송 성공 수</div>
          <div class="card__value" th:text="${sendingSentCount} ?: 0">0</div>
        </div>

        <div class="card is-clickable"
             th:onclick="|location.href='@{/sending(billing_yyyymm=${billing_yyyymm}, status='FAILED')}'|">
          <div class="card__label">발송 실패 수</div>
          <div class="card__value" th:text="${sendingFailedCount} ?: 0">0</div>
        </div>
      </div>

      <!-- Recent Batch Attempts -->
      <div class="mt-20">
        <div class="section-head">
          <h3 class="section-title">최근 배치 이력 (최근 5건)</h3>
          <a class="btn btn--primary" th:href="@{/batch-jobs(billing_yyyymm=${billing_yyyymm})}">Batch Jobs로 이동</a>
        </div>

        <div class="table-wrap" th:if="${batchRecentAttempts != null and !#lists.isEmpty(batchRecentAttempts)}">
          <table class="table">
            <thead>
            <tr>
              <th width="10%">attemptId</th>
              <th width="10%">targetYyyymm</th>
              <th width="12%">status</th>
              <th width="10%">type</th>
              <th width="16%">started</th>
              <th width="16%">ended</th>
              <th width="10%">durationMs</th>
              <th width="8%">ok</th>
              <th width="8%">fail</th>
              <th>host</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="a : ${batchRecentAttempts}">
              <td th:text="${a.attemptId()}">-</td>
              <td th:text="${a.targetYyyymm()}">-</td>
              <td th:text="${a.executionStatus()}">-</td>
              <td th:text="${a.executionType()}">-</td>
              <td th:text="${a.startedAt()}">-</td>
              <td th:text="${a.endedAt()}">-</td>
              <td th:text="${a.durationMs()}">-</td>
              <td th:text="${a.successCount()}">-</td>
              <td th:text="${a.failCount()}">-</td>
              <td th:text="${a.hostName()}">-</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="empty" th:if="${batchRecentAttempts == null or #lists.isEmpty(batchRecentAttempts)}">
          <div class="empty__title">배치 실행 이력이 없습니다</div>
          <div class="empty__desc">monthly_invoice_batch_attempt 테이블에 데이터가 쌓이면 최신 5건이 표시됩니다.</div>
        </div>
      </div>

      <!-- Recent Sending History -->
      <div class="mt-20">
        <div class="section-head">
          <h3 class="section-title">최근 발송 이력 (최근 8건)</h3>
          <a class="btn btn--primary" th:href="@{/sending(billing_yyyymm=${billing_yyyymm})}">Sending으로 이동</a>
        </div>

        <div class="table-wrap" th:if="${recentSendingHistory != null and !#lists.isEmpty(recentSendingHistory)}">
          <table class="table">
            <thead>
            <tr>
              <th width="12%">Invoice</th>
              <th width="10%">User</th>
              <th width="10%">Channel</th>
              <th width="10%">Status</th>
              <th width="18%">Requested</th>
              <th>Error</th>
              <th width="10%" class="ta-center">Link</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="h : ${recentSendingHistory}">
              <td th:text="${h.invoiceId()}">-</td>
              <td th:text="${h.usersId()}">-</td>
              <td th:text="${h.channel()}">-</td>
              <td th:text="${h.status()}">-</td>
              <td th:text="${h.requestedAtText()}">-</td>
              <td th:text="${h.errorMessage()}">-</td>
              <td class="ta-center">
                <a class="btn btn--ghost"
                   th:href="@{/sending(billing_yyyymm=${billing_yyyymm}, invoice_id=${h.invoiceId()})}">
                  보기
                </a>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="empty" th:if="${recentSendingHistory == null or #lists.isEmpty(recentSendingHistory)}">
          <div class="empty__title">최근 발송 이력이 없습니다</div>
          <div class="empty__desc">delivery_history 테이블에서 최근 요청/전송 이력을 조회합니다.</div>
        </div>
      </div>

    </div>
  </div>
</section>

</body>
</html>
