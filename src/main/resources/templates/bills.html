<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::#content})}">
<body>
<section id="content" th:with="pageTitle='BILLS', activeMenu='bills'">
      <!-- Page head -->
      <div class="pagehead">
        <div>
          <div class="pagehead__sub">
            월별 정산 배치 결과와 생성된 청구서를 조회합니다. 탭별로 attempt → invoice → fail/history로 drill-down 합니다.
          </div>
        </div>
        <div class="pagehead__right panel__meta">
          <span class="chip chip--neutral" id="js-current-tab">TAB: <strong>-</strong></span>
          <span class="chip chip--neutral">YYYYMM: <strong th:text="${target_yyyymm != null ? target_yyyymm : '202601'}">202601</strong></span>
          <span class="chip chip--neutral">attempt_id: <strong th:text="${attempt_id != null ? attempt_id : '-'}">-</strong></span>
          <span class="chip chip--neutral">invoice_id: <strong th:text="${invoice_id != null ? invoice_id : '-'}">-</strong></span>
        </div>
      </div>

      <!-- Filter Bar -->
      <form class="filterbar" th:action="@{/bills}" method="get">
        <div class="filterbar__row">
          <div class="field">
            <div class="label">Billing YYYYMM</div>
            <input class="input w-140" type="text" name="target_yyyymm" placeholder="202601"
                   th:value="${target_yyyymm}" />
          </div>

          <div class="field">
            <div class="label">Attempt ID</div>
            <input class="input w-160" type="text" name="attempt_id" placeholder="1000001"
                   th:value="${attempt_id}" />
          </div>

          <div class="field">
            <div class="label">Invoice ID</div>
            <input class="input w-160" type="text" name="invoice_id" placeholder="2000001"
                   th:value="${invoice_id}" />
          </div>

          <div class="field">
            <div class="label">Users ID</div>
            <input class="input w-140" type="text" name="users_id" placeholder="10001"
                   th:value="${users_id}" />
          </div>

          <input type="hidden" name="tab" th:value="${tab}" />

          <button class="btn btn--primary" type="submit">Apply</button>
          <a class="btn btn--ghost" th:href="@{/bills(tab=${tab})}" href="bills.html">Reset</a>
        </div>

        <div class="hint mt-8">
          <strong>팁:</strong> attempt_id를 선택하면 Failures/History가 그 attempt 기준으로 고정됩니다.
        </div>
      </form>

      <!-- Main Panel -->
      <section class="panel">
        <div class="panel__head">
          <h2 class="panel__title">Monthly Billing</h2>
          <div class="panel__meta">
            <span class="chip chip--neutral">Attempts</span>
            <span class="chip chip--neutral">Invoices</span>
            <span class="chip chip--neutral">Failures</span>
          </div>
        </div>

        <div class="panel__body">

          <!-- Tabs -->
          <div class="tabs" data-tab-param="tab" data-indicator="#js-current-tab">
            <a class="tab"
               th:classappend="${tab == null or tab == 'attempts'} ? ' is-active' : ''"
               th:href="@{/bills(tab='attempts', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id}, invoice_id=${invoice_id}, users_id=${users_id})}"
               href="?tab=attempts">
              Batch Attempts
            </a>
            <a class="tab"
               th:classappend="${tab == 'invoices'} ? ' is-active' : ''"
               th:href="@{/bills(tab='invoices', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id}, invoice_id=${invoice_id}, users_id=${users_id})}"
               href="?tab=invoices">
              Invoices
            </a>
            <a class="tab"
               th:classappend="${tab == 'fails'} ? ' is-active' : ''"
               th:href="@{/bills(tab='fails', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id})}"
               href="?tab=fails">
              Failures
            </a>
            <a class="tab"
               th:classappend="${tab == 'history'} ? ' is-active' : ''"
               th:href="@{/bills(tab='history', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id})}"
               href="?tab=history">
              Status History
            </a>
          </div>

          <!-- Tab Description (요구사항: 각 탭 설명 텍스트 추가) -->
          <div class="alert alert--info mb-14">
            <div>
              <p class="alert__title"
                 th:text="${(tab == null or tab == 'attempts') ? 'Batch Attempts — 월별 정산 배치 실행 결과' :
                            (tab == 'invoices') ? 'Invoices — 생성된 청구서 목록' :
                            (tab == 'fails') ? 'Failures — 배치 실패 원인 목록' :
                            'Status History — 정산 상태 변경 이력'}">
                Batch Attempts — 월별 정산 배치 실행 결과
              </p>
              <p class="alert__desc"
                 th:text="${(tab == null or tab == 'attempts') ? 'monthly_invoice_batch_attempt를 조회합니다. 행 클릭 시 attempt_id가 고정되며, Failures/History 탭이 해당 attempt 기준으로 동작합니다.' :
                            (tab == 'invoices') ? 'monthly_invoice 목록입니다. 행 클릭 시 invoice_id가 고정되고, 상세 라인아이템(monthly_invoice_detail)을 함께 확인합니다.' :
                            (tab == 'fails') ? 'monthly_invoice_batch_fail 목록입니다. 선택된 attempt_id 기준이며 error_code/message로 원인을 파악합니다.' :
                            'settlement_status_history 목록입니다. attempt_id 기준 from→to 변경 이력을 보고 invoice로 이동해 영향 범위를 확인합니다.'}">
                monthly_invoice_batch_attempt를 조회합니다. 행 클릭 시 attempt_id가 고정되며, Failures/History 탭이 해당 attempt 기준으로 동작합니다.
              </p>
            </div>
            <div class="alert__actions">
              <a class="btn btn--ghost btn--small" th:href="@{/bills(tab='fails', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id})}" href="?tab=fails">Go Failures</a>
              <a class="btn btn--ghost btn--small" th:href="@{/bills(tab='history', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id})}" href="?tab=history">Go History</a>
            </div>
          </div>

          <!-- Attempts Tab -->
          <div th:if="${tab == null or tab == 'attempts'}">
            <div class="split split--narrow-right">

              <div class="panel panel--list">
                <div class="panel__head">
                  <h3 class="section-title">Attempts</h3>
                  <div class="panel__meta">
                    <span class="chip chip--neutral">click row → select attempt_id</span>
                  </div>
                </div>

                <div class="panel__body" style="padding:0">
                  <div class="table-wrap">
                    <table class="table">
                      <thead>
                      <tr>
                        <th class="col-md">attempt_id</th>
                        <th class="col-sm">yyyymm</th>
                        <th class="col-sm">status</th>
                        <th class="col-sm">type</th>
                        <th class="col-sm ta-right">targets</th>
                        <th class="col-xs ta-right">ok</th>
                        <th class="col-xs ta-right">fail</th>
                        <th class="col-md">started</th>
                        <th class="col-sm ta-right">duration</th>
                      </tr>
                      </thead>
                      <tbody>
                      <tr th:each="a : ${attempts}"
                          th:classappend="${a.attemptId == attempt_id} ? ' is-selected' : ''"
                          style="cursor:pointer"
                          th:onclick="|window.location='@{/bills(tab='attempts', target_yyyymm=${target_yyyymm}, attempt_id=${a.attemptId})}'|">
                        <td th:text="${a.attemptId}">1001</td>
                        <td th:text="${a.targetYyyymm}">202601</td>
                        <td>
                          <span class="chip chip--status"
                                th:classappend="${a.executionStatus == 'FAILED'} ? ' chip--failed' :
                                                (${a.endedAt} == null) ? ' chip--pending' :
                                                ' chip--completed'"
                                th:text="${a.endedAt == null ? 'RUNNING' : a.executionStatus}">
                            COMPLETED
                          </span>
                        </td>
                        <td th:text="${a.executionType}">SCHEDULED</td>
                        <td class="ta-right" th:text="${a.targetCount}">100000</td>
                        <td class="ta-right" th:text="${a.successCount}">99900</td>
                        <td class="ta-right" th:text="${a.failCount}">100</td>
                        <td th:text="${#temporals.format(a.startedAt, 'yyyy-MM-dd HH:mm')}">2026-01-01 00:00</td>
                        <td class="ta-right" th:text="${a.durationMs != null ? a.durationMs + 'ms' : '-'}">-</td>
                      </tr>

                      <tr th:if="${attempts == null or #lists.isEmpty(attempts)}">
                        <td class="td-muted" colspan="9">No attempts</td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Right side: selected attempt KPI -->
              <div class="panel panel--side">
                <div class="panel__head">
                  <h3 class="section-title">Selected Attempt</h3>
                  <div class="panel__meta">
                    <span class="chip chip--neutral">attempt_id: <strong th:text="${attempt_id != null ? attempt_id : '-'}">-</strong></span>
                  </div>
                </div>
                <div class="panel__body">
                  <div class="kpi">
                    <div class="kpi__item">
                      <div class="kpi__label">Targets</div>
                      <div class="kpi__value" th:text="${selectedAttempt != null ? selectedAttempt.targetCount : 0}">0</div>
                    </div>
                    <div class="kpi__item">
                      <div class="kpi__label">Success</div>
                      <div class="kpi__value kpi__value--success" th:text="${selectedAttempt != null ? selectedAttempt.successCount : 0}">0</div>
                    </div>
                    <div class="kpi__item">
                      <div class="kpi__label">Fail</div>
                      <div class="kpi__value kpi__value--danger" th:text="${selectedAttempt != null ? selectedAttempt.failCount : 0}">0</div>
                    </div>
                    <div class="kpi__item">
                      <div class="kpi__label">Duration</div>
                      <div class="kpi__value" th:text="${selectedAttempt != null && selectedAttempt.durationMs != null ? selectedAttempt.durationMs + 'ms' : '-'}">-</div>
                    </div>
                  </div>

                  <div class="row mt-14">
                    <a class="btn btn--primary" th:href="@{/bills(tab='fails', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id})}" href="?tab=fails">Failures</a>
                    <a class="btn btn--ghost" th:href="@{/bills(tab='history', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id})}" href="?tab=history">History</a>
                    <a class="btn btn--quiet" th:href="@{/bills(tab='invoices', target_yyyymm=${target_yyyymm})}" href="?tab=invoices">Go Invoices</a>
                  </div>

                  <div class="hint mt-12">
                    <strong>규칙:</strong> attempt_id가 비어 있으면 Failures/History는 의미가 약합니다(기준이 사라짐).
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Invoices Tab -->
          <div th:if="${tab == 'invoices'}">
            <div class="split split--narrow-right">

              <div class="panel panel--list">
                <div class="panel__head">
                  <h3 class="section-title">Invoices</h3>
                  <div class="panel__meta">
                    <span class="chip chip--neutral">click row → select invoice_id</span>
                  </div>
                </div>

                <div class="panel__body" style="padding:0">
                  <div class="table-wrap">
                    <table class="table bills-table">
                      <thead>
                      <tr>
                        <th class="col-md">invoice_id</th>
                        <th class="col-sm">users_id</th>
                        <th class="col-md ta-right">total_amount</th>
                        <th class="col-md ta-right">discount</th>
                        <th class="col-md">due_date</th>
                        <th class="col-md">created_at</th>
                      </tr>
                      </thead>
                      <tbody>
                      <tr th:each="inv : ${invoices}"
                          th:classappend="${inv.invoiceId == invoice_id} ? ' is-selected' : ''"
                          style="cursor:pointer"
                          th:onclick="|window.location='@{/bills(tab='invoices', target_yyyymm=${target_yyyymm}, invoice_id=${inv.invoiceId})}'|">
                        <td th:text="${inv.invoiceId}">2001</td>
                        <td th:text="${inv.usersId}">10001</td>
                        <td class="ta-right">
                          <div class="amount-strong" th:text="${inv.totalAmount}">0</div>
                        </td>
                        <td class="ta-right" th:text="${inv.totalDiscountAmount}">0</td>
                        <td th:text="${inv.dueDate}">2026-02-01</td>
                        <td th:text="${#temporals.format(inv.createdAt, 'yyyy-MM-dd HH:mm')}">2026-01-01 00:00</td>
                      </tr>

                      <tr th:if="${invoices == null or #lists.isEmpty(invoices)}">
                        <td class="td-muted" colspan="6">No invoices</td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Right side: invoice detail -->
              <div class="panel panel--side">
                <div class="panel__head">
                  <h3 class="section-title">Invoice Detail</h3>
                  <div class="panel__meta">
                    <span class="chip chip--neutral">invoice_id: <strong th:text="${invoice_id != null ? invoice_id : '-'}">-</strong></span>
                  </div>
                </div>
                <div class="panel__body">

                  <div class="kv">
                    <div class="kv__key">users_id</div>
                    <div class="kv__val" th:text="${selectedInvoice != null ? selectedInvoice.usersId : '-'}">-</div>

                    <div class="kv__key">billing_yyyymm</div>
                    <div class="kv__val" th:text="${selectedInvoice != null ? selectedInvoice.billingYyyymm : '-'}">-</div>

                    <div class="kv__key">total_amount</div>
                    <div class="kv__val kv__val--strong" th:text="${selectedInvoice != null ? selectedInvoice.totalAmount : 0}">0</div>

                    <div class="kv__key">due_date</div>
                    <div class="kv__val" th:text="${selectedInvoice != null ? selectedInvoice.dueDate : '-'}">-</div>
                  </div>

                  <div class="section-head mt-14">
                    <h4 class="section-title">Line Items</h4>
                    <div class="hint">monthly_invoice_detail</div>
                  </div>

                  <div class="table-wrap is-sticky">
                    <table class="table">
                      <thead>
                      <tr>
                        <th class="col-md">category</th>
                        <th>service</th>
                        <th class="col-sm ta-right">total</th>
                        <th class="col-lg">usage</th>
                      </tr>
                      </thead>
                      <tbody>
                      <tr th:each="d : ${invoiceDetails}">
                        <td th:text="${d.categoryName}">요금제</td>
                        <td th:text="${d.serviceName}">상품</td>
                        <td class="ta-right" th:text="${d.totalAmount}">0</td>
                        <td th:text="${d.usageStartDate + ' ~ ' + d.usageEndDate}">-</td>
                      </tr>
                      <tr th:if="${invoiceDetails == null or #lists.isEmpty(invoiceDetails)}">
                        <td class="td-muted" colspan="4">No line items</td>
                      </tr>
                      </tbody>
                    </table>
                  </div>

                  <div class="row mt-14">
                    <a class="btn btn--ghost" th:href="@{/bills(tab='fails', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id})}" href="?tab=fails">Failures</a>
                    <a class="btn btn--ghost" th:href="@{/bills(tab='history', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id})}" href="?tab=history">History</a>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Failures Tab -->
          <div th:if="${tab == 'fails'}">
            <div class="section-head">
              <h3 class="section-title">Failures</h3>
              <div class="pagehead__right">
                <a class="btn btn--ghost btn--small"
                   th:href="@{/bills(tab='fails', target_yyyymm=${target_yyyymm}, attempt_id=${attempt_id}, export='csv')}"
                   href="#">
                  Export CSV
                </a>
              </div>
            </div>

            <div class="table-wrap">
              <table class="table">
                <thead>
                <tr>
                  <th class="col-md">fail_id</th>
                  <th class="col-md">category</th>
                  <th class="col-md">billing_history_id</th>
                  <th class="col-md">error_code</th>
                  <th>error_message</th>
                  <th class="col-md">created_at</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="f : ${fails}">
                  <td th:text="${f.failId}">1</td>
                  <td th:text="${f.categoryName}">요금제</td>
                  <td th:text="${f.billingHistoryId}">5001</td>
                  <td><span class="chip chip--danger" th:text="${f.errorCode}">ERR</span></td>
                  <td class="truncate" th:text="${f.errorMessage}">message...</td>
                  <td th:text="${#temporals.format(f.createdAt, 'yyyy-MM-dd HH:mm')}">2026-01-01 00:00</td>
                </tr>
                <tr th:if="${fails == null or #lists.isEmpty(fails)}">
                  <td class="td-muted" colspan="6">No failures</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- History Tab -->
          <div th:if="${tab == 'history'}">
            <div class="section-head">
              <h3 class="section-title">Settlement Status History</h3>
              <div class="hint">attempt_id 기준</div>
            </div>

            <div class="table-wrap">
              <table class="table">
                <thead>
                <tr>
                  <th class="col-md">changed_at</th>
                  <th class="col-md">invoice_id</th>
                  <th class="col-sm">from</th>
                  <th class="col-sm">to</th>
                  <th class="col-md">reason_code</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="h : ${statusHistory}">
                  <td th:text="${#temporals.format(h.changedAt, 'yyyy-MM-dd HH:mm')}">2026-01-01 00:00</td>
                  <td>
                    <a class="link"
                       th:href="@{/bills(tab='invoices', target_yyyymm=${target_yyyymm}, invoice_id=${h.invoiceId})}"
                       th:text="${h.invoiceId}">
                      2001
                    </a>
                  </td>
                  <td><span class="chip chip--neutral" th:text="${h.fromStatus}">NONE</span></td>
                  <td><span class="chip chip--success" th:text="${h.toStatus}">COMPLETED</span></td>
                  <td class="truncate" th:text="${h.reasonCode}">-</td>
                </tr>
                <tr th:if="${statusHistory == null or #lists.isEmpty(statusHistory)}">
                  <td class="td-muted" colspan="5">No history</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

    </div>

    
</section>
</body>
</html>
