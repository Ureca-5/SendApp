<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::#content})}">
<body>

<section id="content">
  <div class="panel">

    <div class="panel__head">
      <h2 class="panel__title">Batch Jobs</h2>
      <div class="panel__meta">
        <span class="chip">YYYYMM: <strong th:text="${billing_yyyymm} ?: '-'">-</strong></span>
      </div>
    </div>

    <div class="panel__body">

      <!-- 검색 -->
      <form class="filterbar" method="get" th:action="${filterAction}">
        <div class="filterbar__row">
          <div class="field">
            <label class="label">정산월(YYYYMM)</label>
            <input type="number" name="billing_yyyymm" class="input w-140"
                   th:value="${billing_yyyymm}" placeholder="202601" />
            <input type="hidden" name="mock" th:value="${param.mock}" />
          </div>

          <div class="field field--actions">
            <button class="btn btn--primary" type="submit">조회</button>
          </div>
        </div>
      </form>

      <div th:if="${billing_yyyymm == null}" class="empty">
        <div class="empty__title">정산월을 입력하세요</div>
        <div class="empty__desc">정산월(YYYYMM)을 입력하면 상태 통계와 최근 시도를 확인할 수 있습니다.</div>
      </div>

      <div th:if="${billing_yyyymm != null}">

        <!-- 상태 통계 -->
        <div class="mt-20">
          <div class="section-head">
            <h3 class="section-title">월별 상태 통계</h3>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
              <tr>
                <th>Status</th>
                <th class="ta-right">Count</th>
              </tr>
              </thead>
              <tbody>
              <tr th:if="${#lists.isEmpty(statusStats)}">
                <td colspan="2" class="td-muted">통계 데이터 없음</td>
              </tr>
              <tr th:each="s : ${statusStats}">
                <td th:text="${s.status}">COMPLETED</td>
                <td class="ta-right" th:text="${s.count}">0</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 최근 시도 -->
        <div class="mt-20">
          <div class="section-head">
            <h3 class="section-title">최근 시도(최신순)</h3>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
              <tr>
                <th width="8%">attemptId</th>
                <th width="10%">status</th>
                <th width="16%">startedAt</th>
                <th width="16%">finishedAt</th>
                <th class="ta-right" width="8%">target</th>
                <th class="ta-right" width="8%">processed</th>
                <th class="ta-right" width="8%">fail</th>
                <th width="12%">host</th>
                <th>error</th>
                <th width="8%" class="ta-center">detail</th>
              </tr>
              </thead>
              <tbody>
              <tr th:if="${#lists.isEmpty(attemptRows)}">
                <td colspan="10" class="td-muted">최근 시도 없음</td>
              </tr>
              <tr th:each="r : ${attemptRows}">
                <td th:text="${r.attemptId}">1</td>
                <td th:text="${r.status}">COMPLETED</td>
                <td th:text="${r.startedAt}">-</td>
                <td th:text="${r.finishedAt}">-</td>
                <td class="ta-right" th:text="${r.targetUserCount}">0</td>
                <td class="ta-right" th:text="${r.processedUserCount}">0</td>
                <td class="ta-right" th:text="${r.failCount}">0</td>
                <td th:text="${r.hostName}">host</td>
                <td th:text="${r.errorMessage}">-</td>
                <td class="ta-center">
                  <a class="btn btn--ghost btn--small"
                     th:href="@{/batch-jobs(billing_yyyymm=${billing_yyyymm}, attempt_id=${r.attemptId}, mock=${param.mock})}">
                    보기
                  </a>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>
  </div>

  <!-- attempt 상세 -->
  <div class="panel mt-20" th:if="${attemptDetail != null}">
    <div class="panel__head">
      <h2 class="panel__title">Attempt 상세</h2>
      <div class="panel__meta">
        <span class="chip">attemptId: <strong th:text="${attemptDetail.attemptId}">-</strong></span>
        <span class="chip">status: <strong th:text="${attemptDetail.status}">-</strong></span>
        <span class="chip">host: <strong th:text="${attemptDetail.hostName}">-</strong></span>
      </div>
    </div>

    <div class="panel__body">
      <div class="kv">
        <div class="kv__key">기간</div>
        <div>
          <span th:text="${attemptDetail.startedAt}">-</span> ~ <span th:text="${attemptDetail.finishedAt}">-</span>
        </div>

        <div class="kv__key">대상/처리/실패</div>
        <div>
          <span th:text="${attemptDetail.targetUserCount}">0</span> /
          <span th:text="${attemptDetail.processedUserCount}">0</span> /
          <span th:text="${attemptDetail.failCount}">0</span>
        </div>
      </div>

      <div class="mt-20">
        <div class="section-head">
          <h3 class="section-title">Error</h3>
        </div>
        <pre class="codeblock" th:text="${attemptDetail.errorMessage}">-</pre>
      </div>

      <div class="mt-20">
        <div class="section-head">
          <h3 class="section-title">실패 샘플</h3>
        </div>

        <div class="empty" th:if="${#lists.isEmpty(failureRows)}">
          <div class="empty__desc">실패 목록은 DB 계약 확정 후 노출됩니다.</div>
        </div>

        <div class="table-wrap" th:if="${!#lists.isEmpty(failureRows)}">
          <table class="table">
            <thead>
            <tr>
              <th width="12%">usersId</th>
              <th width="12%">invoiceId</th>
              <th width="16%">type</th>
              <th>message</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="f : ${failureRows}">
              <td th:text="${f.usersId}">-</td>
              <td th:text="${f.invoiceId}">-</td>
              <td th:text="${f.failureType}">-</td>
              <td th:text="${f.message}">-</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

</section>

</body>
</html>
